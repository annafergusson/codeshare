<script src="https://cdn.opencpu.org/opencpu-0.4.js"></script>
<script src="https://statistics-is-awesome.org/iNZightR/src-min-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>

<style>
body {
  overflow-y: scroll; /* Show scrollbar */
}

h1 {margin-top: 5px}

.code-output{
  overflow: auto;
}

</style>

<script>
  // line below is need for CORS
// outside of R-based app
//ocpu.seturl("https://cloud.opencpu.org/ocpu/apps/annafergusson/codeshare/R")


$(function() {
    $(".title").after("<button id='so'>Start over</button>");
    $("h3").each(function(index){
      $(this).parent().before('<button class="next">Next</button>');
    })
    
        $(".level2").height(function (index, height) {
    return (height + 200);
});
    
    //hide for reveal later
    $(".level2").css("display","none");
    $(".level3").css("display","none");
    $(".next").css("display","none");
    
    // need better default - like check for anchor?
    $(".level2").first().css( "display", "");
    $(".next").first().css( "display", "");
    
    $(".next").click(function(){
      
          //add extra height to level2 div so can scroll
    $(".level2").height(function (index, height) {
    return (height + 100);
});

      $('html,body').animate({scrollTop: $(this).offset().top}, 500);
      $(this).next().css("display","").next().css("display","");
      $(this).css("display","none");
      $(this).removeClass("next");
    })
    
    $("#so").click(function(){
       window.location.reload(true);
    })
    
    //code stuff
   var editor;
   $('.code-exercise').each(function(index) {
     $(this).before("<button class='code' id='" + index + "'>Run code</button>");
     $(this).after("<div class='code-output'></div>");
     editor = ace.edit(this);
     //editor.setTheme("ace/theme/github");
     editor.getSession().setMode("ace/mode/r");
     editor.setFontSize("14px");
     editor.getSession().setUseWrapMode(true);
     editor.setOptions({maxLines: Infinity});
     editor.setHighlightActiveLine(false);
     editor.setShowPrintMargin(false);
     editor.setShowFoldWidgets(false);
     editor.setBehavioursEnabled(true);
     editor.renderer.setDisplayIndentGuides(false);
     editor.session.getSelection().clearSelection();
   });

  $(".code").click(function(){
       var id = $(this).attr("id");
       $('.code-exercise:eq(' + id + ')').each(function(index) {
        editor = ace.edit(this);
       var codeText = editor.getSession().getValue();
       var rmdText = "```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=5}\n" + codeText + "\n```";
       renderRmd(rmdText, id);
       
       })
    })
    
  function renderRmd(textCode, id){
   var req = ocpu.call("rmdtext", {
      text : textCode
    }, function(session){
    $.get(session.getFileURL("output.html"),            function( data) {
    $('.code-output:eq(' + id + ')').html("");
        $('.code-output:eq(' + id + ')').append(data);   
        })    
    }).fail(function(text){
      alert("Error: " + req.responseText);
    });
  }  
});

// get screen size
//$('#users-device-size').find('div:visible').first().attr('id');
</script>